<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <title>Tienda - Inventario de Usuarios</title>
        <style>
            body { font-family: 'Segoe UI', sans-serif; margin: 20px; background-color: #f0f2f5; display: flex; gap: 20px; }
            .productos-section { flex: 2; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
            .carrito-section { flex: 1; background: #fff; padding: 20px; border-radius: 8px; border: 2px solid #007bff; height: fit-content; position: sticky; top: 20px; }
            .search-bar { width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 4px; }
            .product-card { border: 1px solid #eee; padding: 15px; margin-bottom: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
            .btn-buy { background: #007bff; color: white; border: none; padding: 8px 12px; cursor: pointer; border-radius: 4px; }
            .btn-empty { background: #dc3545; color: white; border: none; width: 100%; padding: 10px; margin-top: 10px; cursor: pointer; }
            .btn-pay { background: #28a745; color: white; border: none; width: 100%; padding: 10px; margin-top: 5px; cursor: pointer; font-weight: bold; }
            .total-box { font-size: 1.2rem; font-weight: bold; margin: 15px 0; border-top: 2px solid #eee; padding-top: 10px; }
        </style>
    </head>
    <body>

        <div class="productos-section">
            <h2>Catálogo de Productos</h2>
            <input type="text" id="buscador" class="search-bar" placeholder="Buscar productos..." onkeyup="filtrarProductos()">
            <div id="listaProductos">
                </div>
        </div>

        <div class="carrito-section">
            <h3>Mi Carrito</h3>
            <div id="contenidoCarrito" style="max-height: 300px; overflow-y: auto;">
                </div>
            <div class="total-box">
                Total: $<span id="totalCarrito">0.00</span> 
            </div>
            <button class="btn-empty" onclick="vaciarCarrito()">Vaciar Carrito</button>
            <button class="btn-pay" onclick="pagar()">Confirmar y Pagar</button>
            <button onclick="logout()" style="margin-top:20px; width:100%; background:#6c757d; color:white; border:none; padding:10px; border-radius:4px; cursor:pointer;">Cerrar Sesión</button>
        </div>

        <script>
            const token = localStorage.getItem('token');

            if (!token) {
                window.location.href = 'login.html';
            }

            async function cargarProductos() {
                try {
                    const res = await fetch('/products');
                    const productos = await res.json();
                    const container = document.getElementById('listaProductos');
                    
                    if (productos.length === 0) {
                        container.innerHTML = "<p>No hay productos disponibles.</p>";
                        return;
                    }

                    container.innerHTML = productos.map(p => `
                        <div class="product-card">
                            <div>
                                <strong>${p.nombre}</strong> (Ref: ${p.codigo})<br>
                                <small>${p.descripcion}</small><br>
                                <span>$${parseFloat(p.precio).toFixed(2)}</span>
                            </div>
                            <button class="btn-buy" onclick="agregarAlCarrito('${p.codigo}')">Agregar</button>
                        </div>
                    `).join('');
                } catch (err) {
                    console.error("Error cargando productos:", err);
                }
            }

            async function agregarAlCarrito(codigo) {
                try {
                    const res = await fetch('/cart', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json', 
                            'Authorization': token 
                        },
                        body: JSON.stringify({ codigo: codigo })
                    });

                    if (res.ok) {
                        console.log("Producto agregado con éxito");
                        await actualizarCarrito(); // Forzamos la actualización de la vista 
                    } else {
                        const errorText = await res.text();
                        alert("Error: " + errorText);
                    }
                } catch (err) {
                    console.error("Error en la petición:", err);
                }
            }

            async function actualizarCarrito() {
                try {
                    const res = await fetch('/cart', {
                        headers: { 'Authorization': token }
                    });
                    
                    const data = await res.json();
                    const container = document.getElementById('contenidoCarrito');
                    const totalSpan = document.getElementById('totalCarrito');

                    // Validamos si hay productos 
                    if (!data.productos || data.productos.length === 0) {
                        container.innerHTML = "<p style='color:gray;'>Tu carrito está vacío.</p>";
                        totalSpan.innerText = "0.00";
                        return;
                    }

                    // Dibujamos los productos en el HTML 
                    container.innerHTML = data.productos.map(p => `
                        <div style="font-size: 0.9rem; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 4px;">
                            ${p.nombre} - <strong>$${parseFloat(p.precio).toFixed(2)}</strong>
                        </div>
                    `).join('');

                    // Mostramos el total calculado enviado por el servidor 
                    totalSpan.innerText = parseFloat(data.total).toFixed(2);

                } catch (err) {
                    console.error("Error al refrescar la vista del carrito:", err);
                }
            }
            async function vaciarCarrito() {
                if (!confirm("¿Vaciar todo el carrito?")) return;
                await fetch('/cart', { 
                    method: 'DELETE', 
                    headers: { 'Authorization': token } 
                });
                actualizarCarrito();
            }
            
            async function pagar() {
                const total = document.getElementById('totalCarrito').innerText;
                if (total === "0.00") return alert("El carrito está vacío");

                // Simulación de confirmación de pago
                if (confirm(`Total a pagar: $${total}. ¿Confirmar transacción?`)) {
                    const res = await fetch('/checkout', {
                        method: 'POST',
                        headers: { 'Authorization': token }
                    });

                    if (res.ok) {
                        alert("¡Pago procesado con éxito!");
                        actualizarCarrito();
                        cargarHistorial(); 
                    }
                }
            }

            // Para mostrar las compras debajo del carrito
            async function cargarHistorial() {
                const res = await fetch('/history', { headers: { 'Authorization': token } });
                const historial = await res.json();
                const container = document.getElementById('listaHistorial') || document.createElement('div');
                
                // Si no existe el contenedor en HTML, creamos dinámicamente
                container.id = 'listaHistorial';
                container.style.marginTop = "20px";
                document.querySelector('.carrito-section').appendChild(container);

                container.innerHTML = '<h4>Historial de Compras</h4>' + historial.reverse().map(o => `
                    <div style="font-size:0.8rem; border-top:1px solid #ddd; padding:5px;">
                        ${o.fecha} - <strong>$${o.total.toFixed(2)}</strong>
                    </div>
                `).join('');
            }

          
            

            function filtrarProductos() {
                const filtro = document.getElementById('buscador').value.toLowerCase();
                const cards = document.getElementsByClassName('product-card');
                for (let card of cards) {
                    card.style.display = card.innerText.toLowerCase().includes(filtro) ? '' : 'none';
                }
            }

            function logout() {
                localStorage.clear();
                window.location.href = 'login.html';
            }

            // Carga inicial
            cargarProductos();
            actualizarCarrito();
            cargarHistorial();
        </script>
    </body>
</html>